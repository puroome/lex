<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vocabulary App</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* 추가된 스타일 */
        .is-flipped {
            transform: rotateY(180deg);
        }
        .disabled {
            pointer-events: none;
            opacity: 0.7;
        }
        .choice-item.correct {
            background-color: #A7F3D0;
            border-color: #34D399;
        }
        .choice-item.incorrect {
            background-color: #FECACA;
            border-color: #F87171;
        }
        .pronunciation-inline {
            font-size: 0.7em;
            color: #4B5563;
            margin-left: 0.5rem;
        }
        .quiz-sentence-indent {
            text-indent: -1.5em;
            padding-left: 1.5em;
        }
        #learning-card-back {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            transform: translateY(100%);
            transition: transform 0.4s ease-in-out;
            display: flex;
            flex-direction: column;
        }
        #learning-card-back.is-slid-up {
            transform: translateY(0);
        }
    </style>
</head>
<body class="bg-gray-100 flex justify-center min-h-screen p-4 pb-24">

    <div id="ime-warning" class="hidden fixed top-1/2 -translate-y-1/2 left-1/2 -translate-x-1/2 bg-red-600/50 text-white py-2 px-5 rounded-lg shadow-xl z-[200] text-lg font-semibold">영어키로 전환하세요.</div>

    <div class="fixed top-0 left-0 right-0 z-50 flex justify-center pointer-events-none">
        <div class="w-full max-w-2xl relative px-4">
            <button id="tts-toggle-btn" class="hidden absolute top-4 left-4 bg-indigo-700 hover:bg-indigo-800 text-white font-bold p-3 rounded-full shadow-lg w-12 h-12 flex items-center justify-center text-sm pointer-events-auto">
                <span id="tts-toggle-text">UK</span>
            </button>
            <button id="home-btn" class="hidden absolute top-4 right-4 bg-gray-700 hover:bg-gray-800 text-white font-bold p-3 rounded-full shadow-lg pointer-events-auto">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
            </button>
        </div>
    </div>

    <div class="w-full max-w-2xl mx-auto pt-20">
        <div id="selection-screen" class="bg-white p-8 rounded-2xl shadow-lg text-center relative">
            <svg class="absolute w-0 h-0">
                <defs>
                    <filter id="icon-shadow" x="-20%" y="-20%" width="140%" height="140%">
                        <feDropShadow dx="1" dy="2" stdDeviation="1.5" flood-color="#000" flood-opacity="0.25"/>
                    </filter>
                </defs>
            </svg>
            <button id="refresh-btn" class="absolute top-6 left-6 z-[110] group">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="24" height="24" class="w-8 h-8 transition-transform duration-500 ease-in-out group-hover:scale-110 group-hover:rotate-180">
                    <rect width="18" height="18" x="3" y="3" rx="3.5" fill="#4285F4" filter="url(#icon-shadow)"></rect>
                    <path d="M 9,8 C 7.34,8 6,9.34 6,11 H 4 C 4,8.24 6.24,6 9,6 V 3 L 13,7 L 9,11 V 8 Z M 15,13 C 16.66,13 18,11.66 18,10 H 20 C 20,12.76 17.76,15 15,15 V 18 L 11,14 L 15,11 V 13 Z" fill="white"/>
                </svg>
            </button>
            <a id="sheet-link" href="https://docs.google.com/spreadsheets/d/1aX-o13iqQBFEJcOQktor9KokstXfvHETA-YNOEs8ugs/edit?usp=sharing" target="_blank" class="absolute top-6 right-6 z-[110] group">
                <svg viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" width="24" height="24" class="w-8 h-8 transition-transform duration-300 ease-in-out group-hover:scale-110 group-hover:-rotate-6">
                    <rect width="18" height="18" x="3" y="3" rx="3.5" fill="#34A853" filter="url(#icon-shadow)"></rect>
                    <path d="M4.2 8.1 H19.8 V10.6 H4.2 Z M8.1 4.2 H10.6 V19.8 H8.1 Z" fill="white"></path>
                </svg>
            </a>
            <h1 class="text-3xl font-bold text-gray-800 mb-2">어휘 학습</h1>
            <p class="text-gray-600 mb-8">원하는 학습 방식을 선택하세요.</p>
            
            <div class="inline-block">
                <div class="flex flex-col sm:flex-row justify-center items-center sm:gap-x-6 gap-y-4">
                    <div class="flex flex-col items-center">
                        <div id="select-learning-btn" class="relative cursor-pointer overflow-hidden rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:scale-105 hover:-rotate-2 w-44 h-44">
                            <img src="https://i.imgur.com/IxcIF3g.jpeg" alt="학습 모드 이미지" class="w-full h-full object-cover">
                        </div>
                    </div>
                    <div class="flex flex-col items-center">
                        <div id="select-quiz-btn" class="relative cursor-pointer overflow-hidden rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:scale-105 hover:rotate-2 w-44 h-44">
                            <img src="https://i.imgur.com/BZL7SjS.jpeg" alt="퀴즈 모드 이미지" class="w-full h-full object-cover">
                        </div>
                    </div>
                </div>
                 <div class="grid grid-cols-2 gap-4 mt-4">
                    <button id="select-dashboard-btn" class="w-full bg-teal-500 hover:bg-teal-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition-colors flex items-center justify-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>
                        학습 통계
                    </button>
                    <button id="select-mistakes-btn" class="w-full bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition-colors flex items-center justify-center gap-2">
                         <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22h6a2 2 0 0 0 2-2V7l-5-5H6a2 2 0 0 0-2 2v5"></path><path d="M14 2v4a2 2 0 0 0 2 2h4"></path><path d="M10.4 12.6a2 2 0 1 1 3 3L8 21l-4 1 1-4Z"></path></svg>
                        오답 노트
                    </button>
                </div>
            </div>
        </div>

        <div id="dashboard-container" class="hidden bg-white p-6 sm:p-8 rounded-2xl shadow-lg">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-6 text-center">학습 통계</h1>
            <div id="dashboard-content" class="space-y-6"></div>
        </div>

        <div id="quiz-mode-container" class="hidden bg-white w-full p-4 rounded-2xl shadow-lg">
            <div id="quiz-selection-screen" class="text-center p-10">
                <h1 class="text-2xl font-bold text-gray-800 mb-6">퀴즈 유형</h1>                
            <p class="text-gray-600 mb-8">원하는 퀴즈 유형을 선택하세요.</p>
                
                <div class="flex flex-col sm:flex-row justify-center items-center gap-4">
                    <div id="start-meaning-quiz-btn" class="relative cursor-pointer overflow-hidden rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:scale-105 hover:-rotate-2 w-40 h-40">
                        <img src="https://i.imgur.com/dc1lQkB.jpeg" alt="뜻 맞히기 이미지" class="w-full h-full object-cover">
                    </div>
                    <div id="start-blank-quiz-btn" class="relative cursor-pointer overflow-hidden rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:scale-105 w-40 h-40">
                        <img src="https://i.imgur.com/OcQ1B0c.jpeg" alt="빈칸 채우기 이미지" class="w-full h-full object-cover">
                    </div>
                    <div id="start-definition-quiz-btn" class="relative cursor-pointer overflow-hidden rounded-2xl shadow-lg hover:shadow-2xl transition-all duration-300 transform hover:scale-105 hover:rotate-2 w-40 h-40">
                        <img src="https://i.imgur.com/HXIrIwu.jpeg" alt="영영풀이 퀴즈 이미지" class="w-full h-full object-cover">
                    </div>
                </div>
            </div>
            <div id="quiz-loader" class="hidden text-center p-10">
                <div class="loader mx-auto"></div>
                <p id="quiz-loader-text" class="mt-4 text-gray-600">퀴즈 데이터를 불러오는 중...</p>
            </div>
            <div id="quiz-content-container" class="hidden">
                <div class="relative">
                    <div id="quiz-card-front" class="w-full">
                        <div id="quiz-question-display" class="bg-green-100 p-4 rounded-lg mb-4 flex min-h-[100px]">
                        </div>
                        <div id="quiz-choices" class="space-y-4 mt-8"></div>
                    </div>
                </div>
            </div>
            <div id="quiz-finished-screen" class="hidden text-center p-10">
                <h2 class="text-3xl font-bold text-green-500 mb-4">수고하셨습니다!</h2>
                <p id="quiz-finished-message" class="text-gray-700 text-lg"></p>
                <div id="more-quizzes-container" class="mt-8"></div>
            </div>
        </div>

        <div id="learning-mode-container" class="hidden">
            <div id="learning-start-screen" class="bg-white p-8 rounded-2xl shadow-lg text-center">
                <div id="learning-start-input-container">
                    <h1 class="text-2xl font-bold text-gray-800 mb-4">학습 모드</h1>
                    <p class="text-gray-600 mb-6">학습시작할 단어를 입력하세요.<br>(비워두면 마지막 학습 위치에서 시작합니다)</p>
                    <input type="text" id="learning-start-word-input" class="w-full border-2 border-gray-300 p-3 rounded-lg text-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition" placeholder="예: euphoria" style="ime-mode: inactive;">
                    <button id="learning-start-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition-colors mt-4">학습 시작</button>
                </div>
                <div id="learning-suggestions-container" class="hidden mt-4 text-left">
                    <p id="learning-suggestions-title" class="text-gray-700 mb-4 text-center">혹시 이 단어를 찾으시나요?</p>
                    <div id="suggestions-columns" class="flex flex-col sm:flex-row gap-4">
                        <div class="flex-1 bg-green-500/20 p-4 rounded-lg">
                            <h3 class="font-bold text-gray-700 mb-2">검색어와 유사</h3>
                            <div id="learning-suggestions-vocab-list" class="space-y-2"></div>
                        </div>
                        <div class="flex-1 bg-red-500/20 p-4 rounded-lg">
                            <h3 class="font-bold text-gray-700 mb-2">검색어가 설명에 포함</h3>
                            <div id="learning-suggestions-explanation-list" class="space-y-2"></div>
                        </div>
                    </div>
                    <button id="learning-back-to-start-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-3 px-4 rounded-lg text-lg transition-colors mt-4">다시 입력</button>
                </div>
            </div>

            <div id="learning-loader" class="hidden text-center p-10 bg-white rounded-2xl shadow-lg">
                <div class="loader mx-auto"></div>
                <p id="learning-loader-text" class="mt-4 text-gray-600">단어 목록을 불러오는 중...</p>
            </div>

            <div id="learning-app-container" class="hidden bg-white p-4 rounded-2xl shadow-lg">
                <div class="relative overflow-hidden">
                    <div id="learning-card-front" class="w-full">
                        <div id="word-header" class="bg-green-100 p-3 rounded-lg mb-4 flex items-baseline justify-center">
                            <h1 id="word-display" class="text-3xl sm:text-4xl font-bold text-center text-gray-800"></h1>
                        </div>
                        <div id="meaning-container" class="border-2 border-gray-200 p-3 rounded-lg mb-4">
                            <p class="text-gray-700 text-lg" id="meaning-display"></p>
                        </div>
                        <div id="explanation-container" class="bg-gray-50 p-3 rounded-lg min-h-[100px]">
                            <div class="text-gray-700 whitespace-pre-wrap" id="explanation-display"></div>
                        </div>
                    </div>
                    <div id="learning-card-back" class="w-full bg-gray-100 p-3 rounded-2xl">
                        <h2 id="learning-back-title" class="text-2xl font-bold text-gray-800 mb-4 break-all flex-shrink-0"></h2>
                        <div id="learning-back-content" class="text-gray-700 whitespace-pre-wrap leading-relaxed overflow-y-auto flex-1"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="learning-fixed-buttons" class="hidden fixed bottom-0 left-0 right-0 p-4 z-40">
        <div class="max-w-2xl mx-auto flex justify-between items-center px-4">
            <button id="prev-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-full w-14 h-14 flex items-center justify-center transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </button>
            <button id="sample-btn" class="transition-transform transform hover:scale-110 focus:outline-none">
                <img id="sample-btn-img" src="" alt="예문/뒤로" class="w-28 h-auto">
            </button>
            <button id="next-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-full w-14 h-14 flex items-center justify-center transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" class="w-6 h-6"><polyline points="9 18 15 12 9 6"></polyline></svg>
            </button>
        </div>
    </div>
    
    <div id="no-sample-message" class="hidden opacity-0 fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-gray-800 text-white py-2 px-4 rounded-full text-lg font-bold transition-opacity duration-300 pointer-events-none">예문이 없어요</div>
    <div id="translation-tooltip" class="hidden absolute bg-black bg-opacity-80 text-white text-sm rounded-lg py-2 px-3 z-[110] max-w-sm pointer-events-none"></div>

    <div id="word-context-menu" class="hidden absolute bg-white rounded-md shadow-lg py-1 z-[120] border border-gray-200 flex flex-col">
        <button id="search-app-context-btn" class="text-left w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 whitespace-nowrap">이 앱</button>
        <button id="search-daum-context-btn" class="text-left w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 whitespace-nowrap">Daum</button>
        <button id="search-naver-context-btn" class="text-left w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 whitespace-nowrap">Naver</button>
        <button id="search-etym-context-btn" class="text-left w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 whitespace-nowrap">어원</button>
        <button id="search-longman-context-btn" class="text-left w-full px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 whitespace-nowrap">Longman</button>
    </div>

    <!-- 
      [수정됨]
      - 오래된 Firebase SDK와 script.js를 삭제했습니다.
      - 아래 script 태그 안에 최신 Firebase SDK 로드 및 앱 로직을 모두 통합했습니다.
    -->
    <script type="module">
        // ================================================================
        // 1. 최신 Firebase SDK (v9+) 모듈 가져오기
        // ================================================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

        // ================================================================
        // 2. Firebase 프로젝트 설정
        // ================================================================
        const firebaseConfig = {
          apiKey: "AIzaSyAX-cFBU45qFZTAtLYPTolSzqqLTfEvjP0",
          authDomain: "word-91148.firebaseapp.com",
          databaseURL: "https://word-91148-default-rtdb.asia-southeast1.firebasedatabase.app",
          projectId: "word-91148",
          storageBucket: "word-91148.appspot.com",
          messagingSenderId: "53576845185",
          appId: "1:53576845185:web:f519aa3ec751e12cb88a80"
        };

        // ================================================================
        // 3. Firebase 앱 초기화
        // ================================================================
        const appFirebase = initializeApp(firebaseConfig);
        const auth = getAuth(appFirebase);
        const database = getDatabase(appFirebase);
        
        // ================================================================
        // 4. 기존 script.js 코드 통합
        // ================================================================
        const app = {
            config: {
                TTS_API_KEY: "AIzaSyAJmQBGY4H9DVMlhMtvAAVMi_4N7__DfKA",
                SCRIPT_URL: "https://script.google.com/macros/s/AKfycbxtkBmzSHFOOwIOrjkbxXsHAKIBkimjuUjVOWEoUEi0vgxKclHlo4PTGnSTUSF29Ydg/exec"
            },
            state: {
                currentVoiceSet: 'UK',
                isSpeaking: false,
                audioContext: null,
                translateDebounceTimeout: null, 
                wordList: [],
                isWordListReady: false,
                longPressTimer: null,
            },
            elements: {
                selectionScreen: document.getElementById('selection-screen'),
                homeBtn: document.getElementById('home-btn'),
                refreshBtn: document.getElementById('refresh-btn'),
                ttsToggleBtn: document.getElementById('tts-toggle-btn'),
                ttsToggleText: document.getElementById('tts-toggle-text'),
                quizModeContainer: document.getElementById('quiz-mode-container'),
                learningModeContainer: document.getElementById('learning-mode-container'),
                dashboardContainer: document.getElementById('dashboard-container'),
                translationTooltip: document.getElementById('translation-tooltip'),
                imeWarning: document.getElementById('ime-warning'),
                noSampleMessage: document.getElementById('no-sample-message'),
                sheetLink: document.getElementById('sheet-link'),
                wordContextMenu: document.getElementById('word-context-menu'),
                searchAppContextBtn: document.getElementById('search-app-context-btn'),
                searchDaumContextBtn: document.getElementById('search-daum-context-btn'),
                searchNaverContextBtn: document.getElementById('search-naver-context-btn'),
                searchEtymContextBtn: document.getElementById('search-etym-context-btn'),
                searchLongmanContextBtn: document.getElementById('search-longman-context-btn'),
                selectLearningBtn: document.getElementById('select-learning-btn'),
                selectQuizBtn: document.getElementById('select-quiz-btn'),
                selectDashboardBtn: document.getElementById('select-dashboard-btn'),
                selectMistakesBtn: document.getElementById('select-mistakes-btn'),
            },
            async init() {
                // Firebase 인증 상태 리스너 설정
                onAuthStateChanged(auth, user => {
                    if (user) {
                        console.log("Firebase 익명 인증 성공:", user.uid);
                        // 인증이 성공하면 데이터 로딩 시작
                        this.initializeCachesAndLoadData();
                    } else {
                        // 사용자가 없으면 익명 로그인 시도
                        signInAnonymously(auth).catch(error => {
                            console.error("Firebase 익명 로그인 실패", error);
                            this.showFatalError(`Firebase 인증 실패: ${error.message}`);
                        });
                    }
                });
            },
            async initializeCachesAndLoadData() {
                 try {
                    await audioCache.init();
                    await translationDBCache.init();
                } catch (e) {
                    console.error("캐시를 초기화할 수 없습니다.", e);
                }
                this.bindGlobalEvents();
                // [수정됨] Firebase에서 데이터 로드
                await api.loadWordListFromFirebase();

                quizMode.init();
                learningMode.init();
                dashboard.init();

                const initialMode = window.location.hash.replace('#', '') || 'selection';
                history.replaceState({ mode: initialMode, options: {} }, '', window.location.href);
                this._renderMode(initialMode);
            },
            bindGlobalEvents() {
                document.getElementById('select-quiz-btn').addEventListener('click', () => this.navigateTo('quiz'));
                document.getElementById('select-learning-btn').addEventListener('click', () => this.navigateTo('learning'));
                
                document.getElementById('select-dashboard-btn').addEventListener('click', async () => {
                    this.navigateTo('dashboard');
                    await new Promise(resolve => setTimeout(resolve, 10)); 
                    dashboard.elements.content.innerHTML = `<div class="text-center p-10"><div class="loader mx-auto"></div><p class="mt-4 text-gray-600">최신 통계를 불러오는 중...</p></div>`;
                    try {
                        // [수정됨] 구글시트가 아닌 Firebase에서 강제 리로드
                        await api.loadWordListFromFirebase(true);
                        dashboard.render();
                    } catch (e) {
                        dashboard.elements.content.innerHTML = `<div class="p-8 text-center text-red-600">통계 데이터를 불러오는데 실패했습니다: ${e.message}</div>`;
                    }
                });

                document.getElementById('select-mistakes-btn').addEventListener('click', async () => {
                    app.showToast('오답 노트를 불러오는 중...');
                    try {
                        await api.loadWordListFromFirebase(true); 
                        const mistakeWords = app.state.wordList
                            .filter(word => word.incorrect === 1)
                            .sort((a, b) => {
                                const dateA = a.lastIncorrect ? new Date(a.lastIncorrect) : new Date(0);
                                const dateB = b.lastIncorrect ? new Date(b.lastIncorrect) : new Date(0);
                                return dateB - dateA;
                            })
                            .map(wordObj => wordObj.word);

                        if (mistakeWords.length === 0) {
                            app.showToast('오답 노트에 단어가 없습니다.', true);
                            return;
                        }
                        this.navigateTo('mistakeReview', { mistakeWords });
                    } catch (e) {
                        app.showToast(`오답 노트 로딩 실패: ${e.message}`, true);
                    }
                });

                this.elements.homeBtn.addEventListener('click', () => this.navigateTo('selection'));
                this.elements.refreshBtn.addEventListener('click', () => this.forceReload());
                this.elements.ttsToggleBtn.addEventListener('click', this.toggleVoiceSet.bind(this));
                document.body.addEventListener('click', () => {
                    if (!this.state.audioContext) {
                        this.state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    }
                }, { once: true });
                
                document.addEventListener('click', (e) => {
                    if (!this.elements.wordContextMenu.contains(e.target)) {
                        ui.hideWordContextMenu();
                    }
                });

                window.addEventListener('popstate', (e) => {
                    const mode = e.state?.mode || 'selection';
                    const options = e.state?.options || {};
                    this._renderMode(mode, options);
                });

                document.addEventListener('contextmenu', (e) => {
                    const target = e.target;
                    const isInteractiveTrigger = target.closest('.interactive-word, #word-display');
                    const isCustomContextMenu = target.closest('#word-context-menu');
                    if (!isInteractiveTrigger && !isCustomContextMenu) {
                        e.preventDefault();
                    }
                });
            },
            navigateTo(mode, options = {}) {
                if (history.state?.mode === mode && mode !== 'learning') return;

                const newPath = mode === 'selection' 
                    ? window.location.pathname + window.location.search
                    : `#${mode}`;

                history.pushState({ mode, options }, '', newPath);
                this._renderMode(mode, options);
            },
            _renderMode(mode, options = {}) {
                this.elements.selectionScreen.classList.add('hidden');
                this.elements.quizModeContainer.classList.add('hidden');
                this.elements.learningModeContainer.classList.add('hidden');
                this.elements.dashboardContainer.classList.add('hidden');
                this.elements.homeBtn.classList.add('hidden');
                this.elements.ttsToggleBtn.classList.add('hidden');
                learningMode.elements.fixedButtons.classList.add('hidden');

                const showCommonButtons = () => {
                    this.elements.homeBtn.classList.remove('hidden');
                    this.elements.ttsToggleBtn.classList.remove('hidden');
                };

                if (mode === 'quiz') {
                    showCommonButtons();
                    this.elements.quizModeContainer.classList.remove('hidden');
                    quizMode.reset();
                } else if (mode === 'learning') {
                    showCommonButtons();
                    this.elements.learningModeContainer.classList.remove('hidden');
                    learningMode.elements.appContainer.classList.add('hidden');
                    learningMode.elements.loader.classList.add('hidden');
                    learningMode.elements.startScreen.classList.remove('hidden');
                    if (options.suggestions && options.title) {
                        learningMode.displaySuggestions(options.suggestions.vocab, options.suggestions.explanation, options.title);
                    } else {
                        learningMode.resetStartScreen();
                    }
                } else if (mode === 'dashboard') {
                    this.elements.homeBtn.classList.remove('hidden');
                    this.elements.dashboardContainer.classList.remove('hidden');
                } else if (mode === 'mistakeReview') {
                    const mistakeWords = options.mistakeWords;
                    if (!mistakeWords || mistakeWords.length === 0) {
                        app.showToast('오답 노트에 단어가 없습니다.', true);
                        this.navigateTo('selection');
                        return;
                    }
                    showCommonButtons();
                    this.elements.learningModeContainer.classList.remove('hidden');
                    learningMode.startMistakeReview(mistakeWords);
                } else { // 'selection' 모드
                    this.elements.selectionScreen.classList.remove('hidden');
                    quizMode.reset();
                    learningMode.reset();
                }
            },
            async forceReload() {
                const isSelectionScreen = !this.elements.selectionScreen.classList.contains('hidden');
                if (!isSelectionScreen) {
                    this.showToast('새로고침은 모드 선택 화면에서만 가능합니다.', true);
                    return;
                }
                
                const elementsToDisable = [
                    this.elements.refreshBtn,
                    this.elements.selectDashboardBtn,
                    this.elements.selectMistakesBtn,
                ];
                const elementsToStyle = [
                     this.elements.sheetLink,
                     this.elements.selectLearningBtn,
                     this.elements.selectQuizBtn,
                ];

                elementsToDisable.forEach(el => { if(el) el.disabled = true; });
                elementsToStyle.forEach(el => { if(el) el.classList.add('pointer-events-none', 'opacity-50'); });
                
                const refreshIcon = this.elements.refreshBtn.querySelector('svg');
                if (refreshIcon) refreshIcon.classList.add('animate-spin');

                try {
                    await api.loadWordListFromFirebase(true);
                    this.showToast('데이터를 성공적으로 새로고침했습니다!');
                } catch(e) {
                    this.showToast('데이터 새로고침에 실패했습니다: ' + e.message, true);
                } finally {
                    elementsToDisable.forEach(el => { if(el) el.disabled = false; });
                    elementsToStyle.forEach(el => { if(el) el.classList.remove('pointer-events-none', 'opacity-50'); });
                    if (refreshIcon) refreshIcon.classList.remove('animate-spin');
                }
            },
            showToast(message, isError = false) {
                const toast = document.createElement('div');
                toast.textContent = message;
                toast.className = `fixed top-20 left-1/2 -translate-x-1/2 text-white py-2 px-5 rounded-lg shadow-xl z-[200] text-lg font-semibold ${isError ? 'bg-red-500' : 'bg-green-500'}`;
                document.body.appendChild(toast);
                setTimeout(() => {
                    toast.style.transition = 'opacity 0.5s';
                    toast.style.opacity = '0';
                    setTimeout(() => toast.remove(), 500);
                }, 2500);
            },
            toggleVoiceSet() {
                const btn = this.elements.ttsToggleBtn;
                btn.classList.toggle('is-flipped');
                setTimeout(() => {
                    this.state.currentVoiceSet = (this.state.currentVoiceSet === 'UK') ? 'US' : 'UK';
                    this.elements.ttsToggleText.textContent = this.state.currentVoiceSet;
                    btn.classList.toggle('bg-indigo-700', this.state.currentVoiceSet === 'UK');
                    btn.classList.toggle('hover:bg-indigo-800', this.state.currentVoiceSet === 'UK');
                    btn.classList.toggle('bg-red-500', this.state.currentVoiceSet === 'US');
                    btn.classList.toggle('hover:bg-red-600', this.state.currentVoiceSet === 'US');
                }, 250);
            },
            showFatalError(message) {
                const selectionDiv = this.elements.selectionScreen;
                selectionDiv.innerHTML = `<div class="p-8 text-center"><h1 class="text-3xl font-bold text-red-600 mb-4">앱 시작 실패</h1><p class="text-gray-700 mb-6">데이터를 불러오는 중 문제가 발생했습니다. <br>Firebase 데이터베이스에 'vocabulary' 데이터가 있는지 확인해주세요.</p><div class="bg-red-50 text-red-700 p-4 rounded-lg text-left text-sm break-all"><p class="font-semibold">오류 정보:</p><p>${message}</p></div></div>`;
                selectionDiv.classList.remove('hidden');
                this.elements.quizModeContainer.classList.add('hidden');
                this.elements.learningModeContainer.classList.add('hidden');
            },
            showImeWarning() {
                this.elements.imeWarning.classList.remove('hidden');
                clearTimeout(this.imeWarningTimeout);
                this.imeWarningTimeout = setTimeout(() => {
                    this.elements.imeWarning.classList.add('hidden');
                }, 2000);
            },
            showNoSampleMessage() {
                const msgEl = this.elements.noSampleMessage;
                msgEl.classList.remove('hidden', 'opacity-0');
                setTimeout(() => {
                    msgEl.classList.add('opacity-0');
                    setTimeout(() => msgEl.classList.add('hidden'), 500);
                }, 1500);
            },
            searchWordInLearningMode(word) {
                if (!word) return;
                const wordList = this.state.wordList;
                const lowerCaseWord = word.toLowerCase();
                const exactMatchIndex = wordList.findIndex(item => item.word.toLowerCase() === lowerCaseWord);
                if (exactMatchIndex !== -1) {
                    this.navigateTo('learning');
                    setTimeout(() => {
                        learningMode.state.isMistakeMode = false;
                        learningMode.state.currentWordList = app.state.wordList;
                        learningMode.state.currentIndex = exactMatchIndex;
                        learningMode.launchApp();
                    }, 50);
                    ui.hideWordContextMenu();
                    return;
                }

                const searchRegex = new RegExp(`\\b${lowerCaseWord}\\b`, 'i');
                const explanationMatches = wordList
                    .map((item, index) => ({ word: item.word, index }))
                    .filter((_, index) => {
                        if (!wordList[index].explanation) return false;
                        const cleanedExplanation = wordList[index].explanation.replace(/\[.*?\]/g, '');
                        return searchRegex.test(cleanedExplanation);
                    });

                const levenshteinSuggestions = wordList.map((item, index) => ({
                    word: item.word,
                    index,
                    distance: utils.levenshteinDistance(lowerCaseWord, item.word.toLowerCase())
                }))
                .sort((a, b) => a.distance - b.distance)
                .slice(0, 5);

                if (explanationMatches.length > 0 || levenshteinSuggestions.length > 0) {
                    const title = `'<strong>${word}</strong>' 관련 단어를 찾았습니다.`;
                    this.navigateTo('learning', { 
                        suggestions: {
                            vocab: levenshteinSuggestions,
                            explanation: explanationMatches
                        }, 
                        title: title 
                    });
                    ui.hideWordContextMenu();
                    return;
                }
                
                const title = `입력하신 단어를 찾을 수 없습니다.<br>혹시 이 단어를 찾으시나요?`;
                this.navigateTo('learning', { suggestions: { vocab: [], explanation: [] }, title: title });
                ui.hideWordContextMenu();
            },
        };

        const audioCache = {
            db: null, dbName: 'ttsAudioCacheDB', storeName: 'audioStore',
            init() {
                return new Promise((resolve, reject) => {
                    if (!('indexedDB' in window)) { console.warn('IndexedDB not supported, TTS caching disabled.'); return resolve(); }
                    const request = indexedDB.open(this.dbName, 1);
                    request.onupgradeneeded = event => { const db = event.target.result; if (!db.objectStoreNames.contains(this.storeName)) { db.createObjectStore(this.storeName); } };
                    request.onsuccess = event => { this.db = event.target.result; resolve(); };
                    request.onerror = event => { console.error("IndexedDB error:", event.target.error); reject(event.target.error); };
                });
            },
            getAudio(key) {
                return new Promise((resolve, reject) => {
                    if (!this.db) return resolve(null);
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.get(key);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => { console.error("IndexedDB get error:", event.target.error); reject(event.target.error); };
                });
            },
            saveAudio(key, audioData) {
                if (!this.db) return;
                try { const transaction = this.db.transaction([this.storeName], 'readwrite'); transaction.objectStore(this.storeName).put(audioData, key); } 
                catch (e) { console.error("IndexedDB save error:", e); }
            }
        };

        const translationDBCache = {
            db: null, dbName: 'translationCacheDB', storeName: 'translationStore',
            init() {
                return new Promise((resolve, reject) => {
                    if (!('indexedDB' in window)) { console.warn('IndexedDB not supported, translation caching disabled.'); return resolve(); }
                    const request = indexedDB.open(this.dbName, 1);
                    request.onupgradeneeded = event => { const db = event.target.result; if (!db.objectStoreNames.contains(this.storeName)) { db.createObjectStore(this.storeName); } };
                    request.onsuccess = event => { this.db = event.target.result; resolve(); };
                    request.onerror = event => { console.error("IndexedDB error:", event.target.error); reject(event.target.error); };
                });
            },
            get(key) {
                return new Promise((resolve, reject) => {
                    if (!this.db) return resolve(null);
                    const transaction = this.db.transaction([this.storeName], 'readonly');
                    const store = transaction.objectStore(this.storeName);
                    const request = store.get(key);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = (event) => { console.error("IndexedDB get error:", event.target.error); reject(event.target.error); };
                });
            },
            save(key, data) {
                if (!this.db) return;
                try { const transaction = this.db.transaction([this.storeName], 'readwrite'); transaction.objectStore(this.storeName).put(data, key); }
                catch (e) { console.error("IndexedDB save error:", e); }
            }
        };

        const api = {
            // [수정됨] Firebase에서 데이터를 불러오는 새 함수
            async loadWordListFromFirebase(force = false) {
                if (force) {
                    sessionStorage.removeItem('wordListCache');
                    app.state.isWordListReady = false;
                }

                if (!force) {
                    try {
                        const cachedData = sessionStorage.getItem('wordListCache');
                        if (cachedData) {
                            app.state.wordList = JSON.parse(cachedData);
                            app.state.isWordListReady = true;
                        }
                    } catch (e) {
                        console.error("세션 스토리지 캐시 로딩 실패:", e);
                        sessionStorage.removeItem('wordListCache');
                    }
                }
                
                if (app.state.isWordListReady && !force) return;

                try {
                    const dbRef = ref(database, 'vocabulary');
                    const snapshot = await get(dbRef);
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        // Firebase에서 받은 객체를 배열로 변환
                        app.state.wordList = Object.values(data);
                        app.state.isWordListReady = true;
                        try {
                            sessionStorage.setItem('wordListCache', JSON.stringify(app.state.wordList));
                        } catch (e) {
                            console.error("세션 스토리지 저장 실패:", e);
                        }
                    } else {
                        throw new Error("Firebase에 'vocabulary' 데이터가 없습니다.");
                    }
                } catch (error) {
                    console.error("Firebase 단어 목록 로딩 실패:", error);
                    if (!app.state.isWordListReady) {
                        app.showFatalError(error.message);
                    }
                    throw error; // 에러를 다시 던져서 호출한 쪽에서 처리하게 함
                }
            },
            async speak(text, contentType = 'word') {
                const voiceSets = {
                    'UK': { 'word': { languageCode: 'en-GB', name: 'en-GB-Wavenet-D', ssmlGender: 'MALE' }, 'sample': { languageCode: 'en-GB', name: 'en-GB-Journey-D', ssmlGender: 'MALE' } },
                    'US': { 'word': { languageCode: 'en-US', name: 'en-US-Wavenet-F', ssmlGender: 'FEMALE' }, 'sample': { languageCode: 'en-US', name: 'en-US-Journey-F', ssmlGender: 'FEMALE' } }
                };

                if (!text || !text.trim() || app.state.isSpeaking) return;
                if (app.state.audioContext.state === 'suspended') app.state.audioContext.resume();
                
                app.state.isSpeaking = true;
                const textWithoutEmoji = text.replace(/^(\p{Emoji_Presentation}|\p{Emoji}\uFE0F)\s*/u, '');
                const processedText = textWithoutEmoji.replace(/\bsb\b/g, 'somebody').replace(/\bsth\b/g, 'something');
                const voiceConfig = voiceSets[app.state.currentVoiceSet][contentType];
                
                const cacheKey = `${processedText}|${voiceConfig.languageCode}|${voiceConfig.name}`;

                const playAudio = async (audioArrayBuffer) => {
                    const audioBuffer = await app.state.audioContext.decodeAudioData(audioArrayBuffer);
                    const source = app.state.audioContext.createBufferSource();
                    source.buffer = audioBuffer;
                    source.connect(app.state.audioContext.destination);
                    source.start(0);
                    source.onended = () => { app.state.isSpeaking = false; };
                };

                try {
                    const cachedAudio = await audioCache.getAudio(cacheKey);
                    if (cachedAudio) {
                        await playAudio(cachedAudio.slice(0)); 
                        return;
                    }

                    const TTS_URL = `https://texttospeech.googleapis.com/v1/text:synthesize?key=${app.config.TTS_API_KEY}`;
                    const response = await fetch(TTS_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ input: { text: processedText }, voice: voiceConfig, audioConfig: { audioEncoding: 'MP3' } })
                    });
                    if (!response.ok) throw new Error(`TTS API Error: ${(await response.json()).error.message}`);
                    
                    const data = await response.json();
                    const byteCharacters = atob(data.audioContent);
                    const byteArray = new Uint8Array(byteCharacters.length).map((_, i) => byteCharacters.charCodeAt(i));
                    const audioArrayBuffer = byteArray.buffer;
                    
                    audioCache.saveAudio(cacheKey, audioArrayBuffer.slice(0)); 
                    
                    await playAudio(audioArrayBuffer);

                } catch (error) {
                    console.error('TTS 재생 또는 캐싱에 실패했습니다:', error);
                    app.state.isSpeaking = false;
                }
            },
            async fetchFromGoogleSheet(action, params = {}) {
                const url = new URL(app.config.SCRIPT_URL);
                url.searchParams.append('action', action);
                for (const key in params) {
                    if (params[key] !== undefined && params[key] !== null) {
                        url.searchParams.append(key, params[key]);
                    }
                }
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (data.error) throw new Error(data.message);
                return data;
            },
            async updateSRSData(word, isCorrect, quizType) {
                try {
                    const response = await this.fetchFromGoogleSheet('updateSRSData', { word, isCorrect, quizType });
                    if (response.success && response.updatedWord) {
                        const wordIndex = app.state.wordList.findIndex(w => w.word === word);
                        if (wordIndex !== -1) {
                            app.state.wordList[wordIndex].srsMeaning = response.updatedWord.srsMeaning;
                            app.state.wordList[wordIndex].srsBlank = response.updatedWord.srsBlank;
                            app.state.wordList[wordIndex].srsDefinition = response.updatedWord.srsDefinition;
                        }
                        sessionStorage.setItem('wordListCache', JSON.stringify(app.state.wordList));
                        
                        document.dispatchEvent(new CustomEvent('wordListUpdated'));
                    }
                } catch (error) {
                    console.error('SRS 데이터 업데이트 실패:', error);
                    app.showToast('학습 상태 업데이트에 실패했습니다.', true);
                }
            },
            async translateText(text) {
                const cacheKey = `translation_${text}`;
                try {
                    const cached = await translationDBCache.get(cacheKey);
                    if (cached) {
                        return cached;
                    }
                } catch (e) {
                    console.error("번역 캐시 읽기 실패:", e);
                }

                try {
                    const data = await this.fetchFromGoogleSheet('translateText', { text });
                    if (data.success && data.translatedText) {
                        try {
                            translationDBCache.save(cacheKey, data.translatedText);
                        } catch (e) {
                            console.error("번역 캐시 저장 실패:", e);
                        }
                        return data.translatedText;
                    } else {
                        throw new Error(data.message || '번역 실패');
                    }
                } catch (error) {
                    console.error('번역 API 호출 실패:', error);
                    return "번역 실패";
                }
            }
        };

        const ui = {
            adjustFontSize(element) {
                element.style.fontSize = '';
                let currentFontSize = parseFloat(window.getComputedStyle(element).fontSize);
                const container = element.parentElement;
                const containerStyle = window.getComputedStyle(container);
                const containerWidth = container.clientWidth - parseFloat(containerStyle.paddingLeft) - parseFloat(containerStyle.paddingRight);
                const minFontSize = 16;
                while (element.scrollWidth > containerWidth && currentFontSize > minFontSize) {
                    element.style.fontSize = `${--currentFontSize}px`;
                }
            },
            async copyToClipboard(text) {
                if (navigator.clipboard) {
                    try { await navigator.clipboard.writeText(text); } 
                    catch (err) { console.error('클립보드 복사 실패:', err); }
                }
            },
            renderInteractiveText(targetElement, text) {
                targetElement.innerHTML = '';
                if (!text || !text.trim()) return;
                const regex = /(\[.*?\])|([a-zA-Z0-9'-]+(?:[\s'-]*[a-zA-Z0-9'-]+)*)/g;
                text.split('\n').forEach(line => {
                    let lastIndex = 0;
                    let match;
                    while ((match = regex.exec(line))) {
                        if (match.index > lastIndex) {
                            targetElement.appendChild(document.createTextNode(line.substring(lastIndex, match.index)));
                        }
                        const [_, nonClickable, englishPhrase] = match;
                        if (englishPhrase) {
                            const span = document.createElement('span');
                            span.textContent = englishPhrase;
                            span.className = 'cursor-pointer hover:bg-yellow-200 p-1 rounded-sm transition-colors interactive-word';

                            span.onclick = () => {
                                clearTimeout(app.state.longPressTimer);
                                api.speak(englishPhrase, 'word');
                                this.copyToClipboard(englishPhrase);
                            };

                            span.oncontextmenu = (e) => {
                                e.preventDefault();
                                this.showWordContextMenu(e, englishPhrase);
                            };

                            let touchMove = false;
                            span.addEventListener('touchstart', (e) => {
                                touchMove = false;
                                clearTimeout(app.state.longPressTimer);
                                app.state.longPressTimer = setTimeout(() => {
                                    if (!touchMove) {
                                        this.showWordContextMenu(e, englishPhrase);
                                    }
                                }, 700);
                            });
                            span.addEventListener('touchmove', () => {
                                touchMove = true;
                                clearTimeout(app.state.longPressTimer);
                            });
                            span.addEventListener('touchend', () => {
                                clearTimeout(app.state.longPressTimer);
                            });
                            targetElement.appendChild(span);
                        } else if (nonClickable) {
                            targetElement.appendChild(document.createTextNode(nonClickable));
                        }
                        lastIndex = regex.lastIndex;
                    }
                    if (lastIndex < line.length) {
                        targetElement.appendChild(document.createTextNode(line.substring(lastIndex)));
                    }
                    targetElement.appendChild(document.createElement('br'));
                });
                if (targetElement.lastChild && targetElement.lastChild.tagName === 'BR') {
                    targetElement.removeChild(targetElement.lastChild);
                }
            },
            handleSentenceMouseOver(event, sentence) {
                clearTimeout(app.state.translateDebounceTimeout);
                app.state.translateDebounceTimeout = setTimeout(async () => {
                    const tooltip = app.elements.translationTooltip;
                    const targetRect = event.target.getBoundingClientRect();

                    Object.assign(tooltip.style, {
                        left: `${targetRect.left + window.scrollX}px`,
                        top: `${targetRect.bottom + window.scrollY + 5}px`
                    });

                    tooltip.textContent = '번역 중...';
                    tooltip.classList.remove('hidden');
                    const translatedText = await api.translateText(sentence);
                    tooltip.textContent = translatedText;
                }, 1000); 
            },
            handleSentenceMouseOut() {
                clearTimeout(app.state.translateDebounceTimeout);
                app.elements.translationTooltip.classList.add('hidden');
            },
            displaySentences(sentences, containerElement) {
                containerElement.innerHTML = '';
                sentences.filter(s => s.trim()).forEach(sentence => {
                    const p = document.createElement('p');
                    p.className = 'p-2 rounded transition-colors cursor-pointer hover:bg-gray-200 sample-sentence';

                    p.onclick = () => api.speak(p.textContent, 'sample');
                    p.addEventListener('mouseover', (e) => {
                        if (e.target.classList.contains('interactive-word')) {
                            this.handleSentenceMouseOut();
                            return;
                        }
                        this.handleSentenceMouseOver(e, p.textContent);
                    });
                    p.addEventListener('mouseout', this.handleSentenceMouseOut);

                    const processTextInto = (targetElement, text) => {
                        const parts = text.split(/([,\s\.'])/g).filter(part => part);

                        parts.forEach(part => {
                            if (/[a-zA-Z]/.test(part)) {
                                const span = document.createElement('span');
                                span.textContent = part;
                                span.className = 'hover:bg-yellow-200 rounded-sm transition-colors interactive-word';
                                
                                span.onclick = (e) => { 
                                    e.stopPropagation(); 
                                    clearTimeout(app.state.longPressTimer); 
                                    api.speak(part, 'word'); 
                                    this.copyToClipboard(part); 
                                };
                                
                                span.oncontextmenu = (e) => { 
                                    e.preventDefault(); 
                                    e.stopPropagation(); 
                                    this.showWordContextMenu(e, part); 
                                };
                                
                                let touchMove = false;
                                span.addEventListener('touchstart', (e) => { e.stopPropagation(); touchMove = false; clearTimeout(app.state.longPressTimer); app.state.longPressTimer = setTimeout(() => { if (!touchMove) { this.showWordContextMenu(e, part); } }, 700); }, { passive: true });
                                span.addEventListener('touchmove', (e) => { e.stopPropagation(); touchMove = true; clearTimeout(app.state.longPressTimer); });
                                span.addEventListener('touchend', (e) => { e.stopPropagation(); clearTimeout(app.state.longPressTimer); });
                                
                                targetElement.appendChild(span);
                            } else {
                                targetElement.appendChild(document.createTextNode(part));
                            }
                        });
                    };

                    const sentenceParts = sentence.split(/(\*.*?\*)/g);
                    sentenceParts.forEach(part => {
                        if (part.startsWith('*') && part.endsWith('*')) {
                            const strong = document.createElement('strong');
                            processTextInto(strong, part.slice(1, -1));
                            p.appendChild(strong);
                        } else if (part) {
                            processTextInto(p, part);
                        }
                    });

                    containerElement.appendChild(p);
                });
            },
            showWordContextMenu(event, word, options = {}) {
                event.preventDefault();
                const menu = app.elements.wordContextMenu;

                app.elements.searchAppContextBtn.style.display = options.hideAppSearch ? 'none' : 'block';
                
                const touch = event.touches ? event.touches[0] : null;
                const x = touch ? touch.clientX : event.clientX;
                const y = touch ? touch.clientY : event.clientY;

                menu.style.top = `${y}px`;
                menu.style.left = `${x}px`;
                menu.classList.remove('hidden');

                const encodedWord = encodeURIComponent(word);

                app.elements.searchAppContextBtn.onclick = () => {
                    app.searchWordInLearningMode(word);
                };
                
                app.elements.searchDaumContextBtn.onclick = () => {
                    window.open(`https://dic.daum.net/search.do?q=${encodedWord}`, 'daum_dictionary_window');
                    this.hideWordContextMenu();
                };
                
                app.elements.searchNaverContextBtn.onclick = () => {
                    window.open(`https://en.dict.naver.com/#/search?query=${encodedWord}`, 'naver_dictionary_window');
                    this.hideWordContextMenu();
                };

                app.elements.searchEtymContextBtn.onclick = () => {
                    window.open(`https://www.etymonline.com/search?q=${encodedWord}`, 'etymonline_window');
                    this.hideWordContextMenu();
                };

                app.elements.searchLongmanContextBtn.onclick = () => {
                    window.open(`https://www.ldoceonline.com/dictionary/${encodedWord}`, 'longman_dictionary_window');
                    this.hideWordContextMenu();
                };
            },
            hideWordContextMenu() {
                app.elements.wordContextMenu.classList.add('hidden');
            }
        };

        const utils = {
            levenshteinDistance(a = '', b = '') {
                const track = Array(b.length + 1).fill(null).map(() => Array(a.length + 1).fill(null));
                for (let i = 0; i <= a.length; i += 1) track[0][i] = i;
                for (let j = 0; j <= b.length; j += 1) track[j][0] = j;
                for (let j = 1; j <= b.length; j += 1) {
                    for (let i = 1; i <= a.length; i += 1) {
                        const indicator = a[i - 1] === b[j - 1] ? 0 : 1;
                        track[j][i] = Math.min(track[j][i - 1] + 1, track[j - 1][i] + 1, track[j - 1][i - 1] + indicator);
                    }
                }
                return track[b.length][a.length];
            }
        };

        const dashboard = {
            elements: {
                container: document.getElementById('dashboard-container'),
                content: document.getElementById('dashboard-content'),
            },
            init() {
                document.addEventListener('wordListUpdated', () => {
                    if (!this.elements.container.classList.contains('hidden')) {
                        this.render();
                    }
                });
            },
            async show() {
                if (!app.state.isWordListReady) {
                    this.elements.content.innerHTML = `<div class="text-center p-10"><div class="loader mx-auto"></div><p class="mt-4 text-gray-600">단어 목록을 동기화하는 중...</p></div>`;
                    await this.waitForWordList();
                }
                this.render();
            },
            async waitForWordList() {
                return new Promise(resolve => {
                    const check = () => {
                        if (app.state.isWordListReady) {
                            resolve();
                        } else {
                            setTimeout(check, 100);
                        }
                    };
                    check();
                });
            },
            render() {
                const wordList = app.state.wordList;
                const totalWords = wordList.length;

                const stages = [
                    { name: '새 단어', count: 0, color: 'bg-gray-400' },
                    { name: '학습 중', count: 0, color: 'bg-blue-500' },
                    { name: '익숙함', count: 0, color: 'bg-yellow-500' },
                    { name: '학습 완료', count: 0, color: 'bg-green-500' }
                ];

                wordList.forEach(word => {
                    const { srsMeaning, srsBlank, srsDefinition } = word;
                    
                    if (srsMeaning === null && srsBlank === null && srsDefinition === null) {
                        stages[0].count++; // 새 단어
                        return;
                    }

                    const score = (srsMeaning === 1 ? 1 : 0) + (srsBlank === 1 ? 1 : 0) + (srsDefinition === 1 ? 1 : 0);

                    if (score === 3) {
                        stages[3].count++; // 학습 완료
                    } else if (score === 2) {
                        stages[2].count++; // 익숙함
                    } else {
                        stages[1].count++; // 학습 중 (0점, 1점)
                    }
                });

                let contentHTML = `
                    <div class="bg-gray-50 p-4 rounded-lg shadow-inner text-center">
                        <p class="text-lg text-gray-600">총 단어 수</p>
                        <p class="text-4xl font-bold text-gray-800">${totalWords}</p>
                    </div>
                    <div>
                        <h2 class="text-xl font-bold text-gray-700 mb-3 text-center">학습 단계별 분포</h2>
                        <div class="space-y-4">
                `;

                stages.forEach(stage => {
                    const percentage = totalWords > 0 ? ((stage.count / totalWords) * 100).toFixed(1) : 0;
                    contentHTML += `
                        <div class="w-full">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-base font-semibold text-gray-700">${stage.name}</span>
                                <span class="text-sm font-medium text-gray-500">${stage.count}개 (${percentage}%)</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-4">
                                <div class="${stage.color} h-4 rounded-full" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                });

                contentHTML += `</div></div>`;
                this.elements.content.innerHTML = contentHTML;
            }
        };

        const quizMode = {
            state: {
                currentQuiz: {},
                quizType: null,
                quizBatch: [],
                isFetching: false,
                isFinished: false,
                allWordsLearned: false,
            },
            elements: {},
            init() {
                this.elements = {
                    quizSelectionScreen: document.getElementById('quiz-selection-screen'),
                    startMeaningQuizBtn: document.getElementById('start-meaning-quiz-btn'),
                    startBlankQuizBtn: document.getElementById('start-blank-quiz-btn'),
                    startDefinitionQuizBtn: document.getElementById('start-definition-quiz-btn'),
                    loader: document.getElementById('quiz-loader'),
                    loaderText: document.getElementById('quiz-loader-text'),
                    contentContainer: document.getElementById('quiz-content-container'),
                    cardFront: document.getElementById('quiz-card-front'),
                    questionDisplay: document.getElementById('quiz-question-display'),
                    choices: document.getElementById('quiz-choices'),
                    finishedScreen: document.getElementById('quiz-finished-screen'),
                    finishedMessage: document.getElementById('quiz-finished-message'),
                };
                this.bindEvents();
            },
            bindEvents() {
                this.elements.startMeaningQuizBtn.addEventListener('click', () => this.start('MULTIPLE_CHOICE_MEANING'));
                this.elements.startBlankQuizBtn.addEventListener('click', () => this.start('FILL_IN_THE_BLANK'));
                this.elements.startDefinitionQuizBtn.addEventListener('click', () => this.start('MULTIPLE_CHOICE_DEFINITION'));

                document.addEventListener('keydown', (e) => {
                    const isQuizModeActive = !this.elements.contentContainer.classList.contains('hidden') && !this.elements.choices.classList.contains('disabled');
                    if (!isQuizModeActive) return;

                    const choiceCount = Array.from(this.elements.choices.children).filter(el => !el.textContent.includes('PASS')).length;
                    
                    if (e.key.toLowerCase() === 'p' || e.key === '0') {
                         e.preventDefault();
                         const passButton = Array.from(this.elements.choices.children).find(el => el.textContent.includes('PASS'));
                         if(passButton) passButton.click();
                    } else {
                        const choiceIndex = parseInt(e.key);
                        if (choiceIndex >= 1 && choiceIndex <= choiceCount) {
                            e.preventDefault();
                            this.elements.choices.children[choiceIndex - 1].click();
                        }
                    }
                });
            },
            async start(quizType) {
                this.state.quizType = quizType;
                this.elements.quizSelectionScreen.classList.add('hidden');
                this.showLoader(true);
                if (!app.state.isWordListReady) {
                    this.elements.loaderText.textContent = "단어 목록 동기화 중...";
                    await this.waitForWordList();
                }
                this.elements.loaderText.textContent = "퀴즈 준비 중...";
                await this.fetchQuizBatch(2);
                this.displayNextQuiz();
            },
            async waitForWordList() {
                return new Promise(resolve => {
                    const interval = setInterval(() => {
                        if(app.state.isWordListReady) {
                            clearInterval(interval);
                            resolve();
                        }
                    }, 100);
                });
            },
            reset() {
                this.state.quizBatch = [];
                this.state.isFetching = false;
                this.state.isFinished = false;
                this.state.allWordsLearned = false;
                this.state.quizType = null;
                this.elements.quizSelectionScreen.classList.remove('hidden');
                this.elements.loader.classList.add('hidden');
                this.elements.contentContainer.classList.add('hidden');
                this.elements.finishedScreen.classList.add('hidden');
            },
            async fetchQuizBatch(batchSize) {
                if (this.state.isFetching || this.state.isFinished) return;
                this.state.isFetching = true;

                const excludeWords = this.state.quizBatch.map(q => q.question.word).join(',');
                
                try {
                    const data = await api.fetchFromGoogleSheet('getQuizBatch', { 
                        quizType: this.state.quizType,
                        batchSize: batchSize,
                        excludeWords: excludeWords
                    });

                    if (data.quizzes && data.quizzes.length > 0) {
                        this.state.quizBatch.push(...data.quizzes);
                    } else {
                        if (this.state.quizBatch.length === 0) {
                            this.state.isFinished = true;
                            this.state.allWordsLearned = data.allWordsLearned;
                        }
                    }
                } catch (error) {
                    console.error("퀴즈 묶음 가져오기 실패:", error);
                    this.showError(error.message);
                } finally {
                    this.state.isFetching = false;
                }
            },
            showError(message) {
                this.elements.loader.querySelector('.loader').style.display = 'none';
                this.elements.loaderText.innerHTML = `<p class="text-red-500 font-bold">퀴즈를 가져올 수 없습니다.</p><p class="text-sm text-gray-600 mt-2 break-all">${message}</p>`;
            },
            displayNextQuiz() {
                if (this.state.quizBatch.length <= 2 && !this.state.isFetching && !this.state.isFinished) {
                    this.fetchQuizBatch(10);
                }

                if (this.state.quizBatch.length === 0) {
                    if (this.state.isFinished) {
                        this.showFinishedScreen();
                    } else {
                        this.showLoader(true, "다음 퀴즈를 불러오는 중...");
                        setTimeout(() => {
                            if (this.state.quizBatch.length > 0) {
                                this.displayNextQuiz();
                            } else {
                                this.state.isFinished = true;
                                this.showFinishedScreen();
                            }
                        }, 1500);
                    }
                    return;
                }
                
                const nextQuiz = this.state.quizBatch.shift();
                this.state.currentQuiz = nextQuiz;
                this.showLoader(false);
                this.renderQuiz(nextQuiz);
            },
            renderQuiz(quizData) {
                this.elements.cardFront.classList.remove('hidden');
                
                const { type, question, choices } = quizData;
                const questionDisplay = this.elements.questionDisplay;
                questionDisplay.innerHTML = '';

                if (type === 'FILL_IN_THE_BLANK') {
                    questionDisplay.classList.remove('justify-center', 'items-center');
                    const sentence = question.sentence_with_blank;

                    const p = document.createElement('p');
                    p.className = 'text-xl sm:text-2xl text-left text-gray-800 leading-relaxed quiz-sentence-indent';

                    const processTextInto = (targetElement, text) => {
                        const parts = text.split(/([,\s\.'])/g).filter(part => part);
                        parts.forEach(part => {
                            if (/[a-zA-Z]/.test(part)) {
                                const span = document.createElement('span');
                                span.textContent = part;
                                span.className = 'hover:bg-yellow-200 rounded-sm transition-colors interactive-word';
                                
                                span.onclick = (e) => { 
                                    e.stopPropagation(); 
                                    clearTimeout(app.state.longPressTimer); 
                                    api.speak(part, 'word'); 
                                    ui.copyToClipboard(part); 
                                };
                                
                                span.oncontextmenu = (e) => { 
                                    e.preventDefault(); 
                                    e.stopPropagation(); 
                                    ui.showWordContextMenu(e, part); 
                                };
                                
                                let touchMove = false;
                                span.addEventListener('touchstart', (e) => { e.stopPropagation(); touchMove = false; clearTimeout(app.state.longPressTimer); app.state.longPressTimer = setTimeout(() => { if (!touchMove) { ui.showWordContextMenu(e, part); } }, 700); }, { passive: true });
                                span.addEventListener('touchmove', (e) => { e.stopPropagation(); touchMove = true; clearTimeout(app.state.longPressTimer); });
                                span.addEventListener('touchend', (e) => { e.stopPropagation(); clearTimeout(app.state.longPressTimer); });
                                
                                targetElement.appendChild(span);
                            } else {
                                targetElement.appendChild(document.createTextNode(part));
                            }
                        });
                    };
                    
                    const sentenceParts = sentence.split(/(\*.*?\*|＿＿＿＿)/g);
                    sentenceParts.forEach(part => {
                        if (part === '＿＿＿＿') {
                            const blankSpan = document.createElement('span');
                            blankSpan.style.whiteSpace = 'nowrap';
                            blankSpan.textContent = '＿＿＿＿';
                            p.appendChild(blankSpan);
                        } else if (part && part.startsWith('*') && part.endsWith('*')) {
                            const strong = document.createElement('strong');
                            processTextInto(strong, part.slice(1, -1));
                            p.appendChild(strong);
                        } else if (part) {
                            processTextInto(p, part);
                        }
                    });

                    questionDisplay.appendChild(p);
                    
                } else if (type === 'MULTIPLE_CHOICE_MEANING') {
                    questionDisplay.classList.add('justify-center', 'items-center');
                    questionDisplay.innerHTML = `<h1 class="text-3xl sm:text-4xl font-bold text-center text-gray-800">${question.word}</h1>`;
                    const wordEl = questionDisplay.querySelector('h1');
                    wordEl.addEventListener('click', () => {
                        api.speak(question.word, 'word');
                        ui.copyToClipboard(question.word);
                    });
                    ui.adjustFontSize(wordEl);
                } else if (type === 'MULTIPLE_CHOICE_DEFINITION') {
                    questionDisplay.classList.remove('justify-center', 'items-center');
                    ui.displaySentences([question.definition], questionDisplay);
                    const sentenceElement = questionDisplay.querySelector('.sample-sentence');
                    if(sentenceElement){
                        sentenceElement.classList.add('text-lg', 'sm:text-xl', 'text-left', 'text-gray-800', 'leading-relaxed');
                        sentenceElement.classList.remove('p-2', 'hover:bg-gray-200');
                    }
                }

                this.elements.choices.innerHTML = '';
                const displayChoices = (type === 'MULTIPLE_CHOICE_MEANING') ? choices.map(c => c.split('\n')[0]) : choices;

                displayChoices.forEach((choice, index) => {
                    const li = document.createElement('li');
                    li.className = 'choice-item border-2 border-gray-300 p-4 rounded-lg cursor-pointer flex items-start transition-all';
                    const choiceText = (type === 'MULTIPLE_CHOICE_MEANING') ? choices[index] : choice;
                    li.innerHTML = `<span class="font-bold mr-3">${index + 1}.</span> <span>${choiceText}</span>`;
                    li.onclick = () => this.checkAnswer(li, choice);
                    this.elements.choices.appendChild(li);
                });
                
                const passLi = document.createElement('li');
                passLi.className = 'choice-item border-2 border-red-500 bg-red-500 hover:bg-red-600 text-white p-4 rounded-lg cursor-pointer flex items-center justify-center transition-all font-bold text-lg';
                passLi.innerHTML = `<span>PASS</span>`;
                passLi.onclick = () => this.checkAnswer(passLi, 'USER_PASSED');
                this.elements.choices.appendChild(passLi);

                this.elements.choices.classList.remove('disabled');
            },
            async checkAnswer(selectedLi, selectedChoice) {
                this.elements.choices.classList.add('disabled');
                
                const isCorrect = selectedChoice === this.state.currentQuiz.answer;
                
                selectedLi.classList.add(isCorrect ? 'correct' : 'incorrect');
                if (!isCorrect) {
                    const correctAnswerEl = Array.from(this.elements.choices.children).find(li => {
                        const choiceSpan = li.querySelector('span:last-child');
                        return choiceSpan && choiceSpan.textContent === this.state.currentQuiz.answer;
                    });
                    correctAnswerEl?.classList.add('correct');
                }
                
                const word = this.state.currentQuiz.question.word;
                
                const wordIndex = app.state.wordList.findIndex(w => w.word === word);
                if(wordIndex !== -1) {
                    const srsKey = {
                        'MULTIPLE_CHOICE_MEANING': 'srsMeaning',
                        'FILL_IN_THE_BLANK': 'srsBlank',
                        'MULTIPLE_CHOICE_DEFINITION': 'srsDefinition'
                    }[this.state.quizType];

                    if (srsKey) {
                        app.state.wordList[wordIndex][srsKey] = isCorrect ? 1 : 0;
                    }
                }

                api.updateSRSData(word, isCorrect, this.state.quizType).catch(e => {
                     console.error("백그라운드 데이터 업데이트 실패:", e);
                });
                
                setTimeout(() => this.displayNextQuiz(), 1000);
            },
            showLoader(isLoading, message = '퀴즈를 준비 중입니다...') {
                this.elements.loader.classList.toggle('hidden', !isLoading);
                this.elements.loaderText.textContent = message;
                this.elements.quizSelectionScreen.classList.add('hidden');
                this.elements.contentContainer.classList.toggle('hidden', isLoading);
                this.elements.finishedScreen.classList.add('hidden');
            },
            showFinishedScreen() {
                this.showLoader(false);
                this.elements.contentContainer.classList.add('hidden');
                this.elements.finishedScreen.classList.remove('hidden');
                if (this.state.allWordsLearned) {
                    this.elements.finishedMessage.innerHTML = "축하합니다!<br>모든 단어 학습을 완료했습니다!";
                } else {
                    this.elements.finishedMessage.innerHTML = "풀 수 있는 퀴즈를 모두 완료했습니다.<br>새로운 단어를 학습하거나 내일 다시 도전해 주세요.";
                }
            },
        };

        const learningMode = {
            state: {
                currentIndex: 0,
                touchstartX: 0,
                touchstartY: 0,
                lastWheelTime: 0,
                isMistakeMode: false,
                currentWordList: [],
            },
            elements: {},
            init() {
                this.elements = {
                    startScreen: document.getElementById('learning-start-screen'),
                    startInputContainer: document.getElementById('learning-start-input-container'),
                    startWordInput: document.getElementById('learning-start-word-input'),
                    startBtn: document.getElementById('learning-start-btn'),
                    suggestionsContainer: document.getElementById('learning-suggestions-container'),
                    suggestionsTitle: document.getElementById('learning-suggestions-title'),
                    suggestionsVocabList: document.getElementById('learning-suggestions-vocab-list'),
                    suggestionsExplanationList: document.getElementById('learning-suggestions-explanation-list'),
                    backToStartBtn: document.getElementById('learning-back-to-start-btn'),
                    loader: document.getElementById('learning-loader'),
                    loaderText: document.getElementById('learning-loader-text'),
                    appContainer: document.getElementById('learning-app-container'),
                    cardBack: document.getElementById('learning-card-back'),
                    wordDisplay: document.getElementById('word-display'),
                    meaningDisplay: document.getElementById('meaning-display'),
                    explanationDisplay: document.getElementById('explanation-display'),
                    explanationContainer: document.getElementById('explanation-container'),
                    fixedButtons: document.getElementById('learning-fixed-buttons'),
                    nextBtn: document.getElementById('next-btn'),
                    prevBtn: document.getElementById('prev-btn'),
                    sampleBtn: document.getElementById('sample-btn'),
                    sampleBtnImg: document.getElementById('sample-btn-img'),
                    backTitle: document.getElementById('learning-back-title'),
                    backContent: document.getElementById('learning-back-content')
                };
                this.bindEvents();
            },
            bindEvents() {
                this.elements.startBtn.addEventListener('click', () => this.start());
                this.elements.startWordInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') this.start(); });
                this.elements.startWordInput.addEventListener('input', (e) => {
                    const originalValue = e.target.value;
                    const sanitizedValue = originalValue.replace(/[^a-zA-Z\s'-]/g, '');
                    if (originalValue !== sanitizedValue) app.showImeWarning();
                    e.target.value = sanitizedValue;
                });
                this.elements.backToStartBtn.addEventListener('click', () => this.resetStartScreen());
                this.elements.nextBtn.addEventListener('click', () => this.navigate(1));
                this.elements.prevBtn.addEventListener('click', () => this.navigate(-1));
                this.elements.sampleBtn.addEventListener('click', () => this.handleFlip());

                this.elements.wordDisplay.addEventListener('click', () => {
                    const word = this.state.currentWordList[this.state.currentIndex]?.word;
                    if (word) {
                        api.speak(word, 'word');
                        ui.copyToClipboard(word);
                    }
                });

                this.elements.wordDisplay.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    const wordData = this.state.currentWordList[this.state.currentIndex];
                    if (wordData) {
                        ui.showWordContextMenu(e, wordData.word, { hideAppSearch: true });
                    }
                });

                let wordDisplayTouchMove = false;
                this.elements.wordDisplay.addEventListener('touchstart', (e) => {
                    wordDisplayTouchMove = false;
                    clearTimeout(app.state.longPressTimer);
                    app.state.longPressTimer = setTimeout(() => {
                        const wordData = this.state.currentWordList[this.state.currentIndex];
                        if (!wordDisplayTouchMove && wordData) {
                            ui.showWordContextMenu(e, wordData.word, { hideAppSearch: true });
                        }
                    }, 700);
                }, { passive: true });
                this.elements.wordDisplay.addEventListener('touchmove', () => {
                    wordDisplayTouchMove = true;
                    clearTimeout(app.state.longPressTimer);
                });
                this.elements.wordDisplay.addEventListener('touchend', () => {
                    clearTimeout(app.state.longPressTimer);
                });

                document.addEventListener('mousedown', this.handleMiddleClick.bind(this));
                document.addEventListener('keydown', this.handleKeyDown.bind(this));
                document.addEventListener('touchstart', this.handleTouchStart.bind(this), { passive: true });
                document.addEventListener('touchend', this.handleTouchEnd.bind(this));
            },
            async start() {
                this.state.isMistakeMode = false;
                this.state.currentWordList = app.state.wordList;

                this.elements.startScreen.classList.add('hidden');
                this.elements.loader.classList.remove('hidden');
                if (!app.state.isWordListReady) {
                    this.elements.loaderText.textContent = "단어 목록을 동기화하는 중...";
                    await this.waitForWordList();
                }
                const startWord = this.elements.startWordInput.value.trim();
                const wordList = this.state.currentWordList;
                if (wordList.length === 0) {
                    this.showError("학습할 단어가 없습니다.");
                    return;
                }
                
                if (!startWord) {
                    this.elements.loaderText.textContent = "마지막 학습 위치를 불러오는 중...";
                    try {
                        const data = await api.fetchFromGoogleSheet('getLastLearnedIndex');
                        const lastIndex = data.index;
                        this.state.currentIndex = (lastIndex && lastIndex >= 0 && lastIndex < wordList.length) ? lastIndex : 0;
                        this.launchApp();
                    } catch (e) {
                        console.error("마지막 학습 위치 로딩 실패:", e);
                        app.showToast("마지막 학습 위치를 불러오는데 실패했습니다. 처음부터 시작합니다.", true);
                        this.state.currentIndex = 0;
                        this.launchApp();
                    }
                    return;
                }
            
                const lowerCaseStartWord = startWord.toLowerCase();
            
                const exactMatchIndex = wordList.findIndex(item => item.word.toLowerCase() === lowerCaseStartWord);
                if (exactMatchIndex !== -1) {
                    this.state.currentIndex = exactMatchIndex;
                    this.launchApp();
                    return;
                }
            
                const searchRegex = new RegExp(`\\b${lowerCaseStartWord}\\b`, 'i');
                const explanationMatches = wordList
                    .map((item, index) => ({ word: item.word, index }))
                    .filter((_, index) => {
                        if (!wordList[index].explanation) return false;
                        const cleanedExplanation = wordList[index].explanation.replace(/\[.*?\]/g, '');
                        return searchRegex.test(cleanedExplanation);
                    });
            
                const levenshteinSuggestions = wordList.map((item, index) => ({
                    word: item.word,
                    index,
                    distance: utils.levenshteinDistance(lowerCaseStartWord, item.word.toLowerCase())
                }))
                .sort((a, b) => a.distance - b.distance)
                .slice(0, 5)
                .filter(s => s.distance < s.word.length / 2 + 1);
            
                if (levenshteinSuggestions.length > 0 || explanationMatches.length > 0) {
                    const title = `<strong>${startWord}</strong> 없으니, 아래에서 확인하세요.`;
                    this.displaySuggestions(levenshteinSuggestions, explanationMatches, title);
                } else {
                    const title = `<strong>${startWord}</strong>에 대한 검색 결과가 없습니다.`;
                    this.displaySuggestions([], [], title);
                }
            },
            async waitForWordList() {
                return new Promise(resolve => {
                    const interval = setInterval(() => {
                        if(app.state.isWordListReady) {
                            clearInterval(interval);
                            resolve();
                        }
                    }, 100);
                });
            },
            showError(message) {
                this.elements.loader.querySelector('.loader').style.display = 'none';
                this.elements.loaderText.innerHTML = `<p class="text-red-500 font-bold">오류 발생</p><p class="text-sm text-gray-600 mt-2 break-all">${message}</p>`;
            },
            launchApp() {
                this.elements.startScreen.classList.add('hidden');
                this.elements.loader.classList.add('hidden');
                this.elements.appContainer.classList.remove('hidden');
                this.elements.fixedButtons.classList.remove('hidden');
                this.displayWord(this.state.currentIndex);
            },
            reset() {
                this.elements.startScreen.classList.remove('hidden');
                this.elements.appContainer.classList.add('hidden');
                this.elements.loader.classList.add('hidden');
                this.elements.fixedButtons.classList.add('hidden');
                this.resetStartScreen();
            },
            resetStartScreen() {
                this.elements.startInputContainer.classList.remove('hidden');
                this.elements.suggestionsContainer.classList.add('hidden');
                this.elements.startWordInput.value = '';
                this.elements.startWordInput.focus();
            },
            displaySuggestions(vocabSuggestions, explanationSuggestions, title) {
                this.elements.loader.classList.add('hidden');
                this.elements.startScreen.classList.remove('hidden');
                this.elements.startInputContainer.classList.add('hidden');
                
                this.elements.suggestionsTitle.innerHTML = title;
                
                this.elements.suggestionsVocabList.innerHTML = '';
                this.elements.suggestionsExplanationList.innerHTML = '';
                
                const populateList = (listElement, suggestions) => {
                    if (suggestions.length === 0) {
                        listElement.innerHTML = '<p class="text-gray-400 text-sm p-3">결과 없음</p>';
                        return;
                    }
                    suggestions.forEach(({ word, index }) => {
                        const btn = document.createElement('button');
                        btn.className = 'w-full text-left bg-gray-100 hover:bg-gray-200 py-3 px-4 rounded-lg transition-colors';
                        btn.textContent = word;
                        btn.onclick = () => {
                            this.state.currentIndex = index;
                            this.launchApp();
                        };
                        listElement.appendChild(btn);
                    });
                };

                populateList(this.elements.suggestionsVocabList, vocabSuggestions);
                populateList(this.elements.suggestionsExplanationList, explanationSuggestions);
                
                this.elements.suggestionsContainer.classList.remove('hidden');
            },
            displayWord(index) {
                if (!this.state.isMistakeMode) {
                    api.fetchFromGoogleSheet('setLastLearnedIndex', { index: index })
                       .catch(err => console.error("백그라운드 학습 위치 저장 실패:", err));
                }

                this.elements.cardBack.classList.remove('is-slid-up');
                const wordData = this.state.currentWordList[index];
                if (!wordData) return;
                
                const wordText = wordData.word;
                const pronText = wordData.pronunciation ? `<span class="pronunciation-inline">${wordData.pronunciation}</span>` : '';
                this.elements.wordDisplay.innerHTML = `${wordText} ${pronText}`;
                
                ui.adjustFontSize(this.elements.wordDisplay);
                
                this.elements.meaningDisplay.innerHTML = wordData.meaning.replace(/\n/g, '<br>');
                ui.renderInteractiveText(this.elements.explanationDisplay, wordData.explanation);
                this.elements.explanationContainer.classList.toggle('hidden', !wordData.explanation || !wordData.explanation.trim());
                
                switch(wordData.sampleSource) {
                    case 'manual':
                        this.elements.sampleBtnImg.src = 'https://images.icon-icons.com/1055/PNG/128/14-delivery-cat_icon-icons.com_76690.png';
                        break;
                    case 'ai':
                        this.elements.sampleBtnImg.src = 'https://images.icon-icons.com/1055/PNG/128/3-search-cat_icon-icons.com_76679.png';
                        break;
                    case 'none':
                    default:
                        this.elements.sampleBtnImg.src = 'https://images.icon-icons.com/1055/PNG/128/19-add-cat_icon-icons.com_76695.png';
                        break;
                }
            },
            navigate(direction) {
                const len = this.state.currentWordList.length;
                if (len === 0) return;
                this.state.currentIndex = (this.state.currentIndex + direction + len) % len;
                this.displayWord(this.state.currentIndex);
            },
            async handleFlip() {
                const isBackVisible = this.elements.cardBack.classList.contains('is-slid-up');
                const wordData = this.state.currentWordList[this.state.currentIndex];

                if (!isBackVisible) {
                    if (wordData.sampleSource === 'none') {
                        app.showNoSampleMessage();
                        return;
                    }
                    
                    this.elements.backTitle.textContent = wordData.word;
                    ui.displaySentences(wordData.sample.split('\n'), this.elements.backContent);
                    this.elements.cardBack.classList.add('is-slid-up');
                    this.elements.sampleBtnImg.src = 'https://images.icon-icons.com/1055/PNG/128/5-remove-cat_icon-icons.com_76681.png';

                } else {
                    this.elements.cardBack.classList.remove('is-slid-up');
                    this.displayWord(this.state.currentIndex);
                }
            },
            async startMistakeReview(mistakeWords) {
                this.elements.startScreen.classList.add('hidden');
                this.elements.loader.classList.remove('hidden');
                
                this.state.isMistakeMode = true;
                
                const wordMap = new Map(app.state.wordList.map(wordObj => [wordObj.word, wordObj]));
                this.state.currentWordList = mistakeWords.map(word => wordMap.get(word));
                
                this.state.currentIndex = 0;
                
                if (this.state.currentWordList.length === 0) {
                    this.showError("오답 노트를 불러올 수 없습니다.");
                    setTimeout(() => app.navigateTo('selection'), 2000);
                    return;
                }
                
                this.launchApp();
            },
            isLearningModeActive() {
                return !this.elements.appContainer.classList.contains('hidden');
            },
            handleMiddleClick(e) {
                if (this.isLearningModeActive() && e.button === 1) {
                    e.preventDefault();
                    this.elements.sampleBtn.click();
                }
            },
            handleKeyDown(e) {
                if (!this.isLearningModeActive() || document.activeElement.tagName.match(/INPUT|TEXTAREA/)) return;
                const keyMap = { 'ArrowLeft': -1, 'ArrowRight': 1 };
                if (keyMap[e.key] !== undefined) {
                    e.preventDefault();
                    this.navigate(keyMap[e.key]);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    this.handleFlip();
                } else if (e.key === ' ') {
                    e.preventDefault();
                    if (!this.elements.cardBack.classList.contains('is-slid-up')) {
                        api.speak(this.elements.wordDisplay.textContent, 'word');
                    }
                }
            },
            handleTouchStart(e) {
                if (!this.isLearningModeActive()) return;
                if (e.target.closest('#word-display')) return;
                this.state.touchstartX = e.changedTouches[0].screenX;
                this.state.touchstartY = e.changedTouches[0].screenY;
            },
            handleTouchEnd(e) {
                if (!this.isLearningModeActive() || this.state.touchstartX === 0) return;
                if (e.target.closest('button, a, input, [onclick], .interactive-word')) {
                     this.state.touchstartX = this.state.touchstartY = 0;
                     return;
                }
                const deltaX = e.changedTouches[0].screenX - this.state.touchstartX;
                const deltaY = e.changedTouches[0].screenY - this.state.touchstartY;
                
                if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
                    this.navigate(deltaX > 0 ? -1 : 1);
                } 
                else if (Math.abs(deltaY) > Math.abs(deltaX) && Math.abs(deltaY) > 50) {
                    if (!e.target.closest('#learning-app-container')) {
                        if (deltaY < 0) { 
                            this.navigate(1); 
                        }
                    }
                }
                this.state.touchstartX = this.state.touchstartY = 0;
            }
        };

        // 앱 실행 시작
        document.addEventListener('DOMContentLoaded', () => {
            app.init();
        });
    </script>
</body>
</html>

